<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UnfollowGuard</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0e101a">
<link rel="icon" href="unfollowguard_logo.png" type="image/png">

<!-- Force old SWs to unregister, then register the new one -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const reg of regs) {
        if (!reg.active || !reg.active.scriptURL.endsWith('sw-v3.js')) {
          try { await reg.unregister(); } catch(e){}
        }
      }
      await navigator.serviceWorker.register('./sw-v3.js', { scope: './' });
      // reload once so the new SW takes control immediately
      if (sessionStorage.getItem('sw-reloaded') !== '1') {
        sessionStorage.setItem('sw-reloaded','1'); location.reload();
      }
    } catch(e) {}
  });
}
</script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg0:#0b0d16;--bg1:#0e101a;--panel:#171a25;--muted:#a6a8b3;--accent:#6c63ff;
    --line:#2e3247;--chip:#24273a;--ink:#e9eaf0;
    --logo-gap:-22px; /* desktop/tablet gap under logo */
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg0),var(--bg1));color:var(--ink)}
  .wrap{
    max-width:1000px;margin:0 auto;
    padding: calc(8px + env(safe-area-inset-top)) 22px 22px; /* iOS safe area */
  }

  /* --- HERO --- */
  .logo{
    display:block;
    max-width: clamp(300px, 42vw, 520px);
    height:auto; aspect-ratio:1/1;
    margin:8px auto var(--logo-gap) auto;
  }
  .subtitle{
    color:var(--muted);
    text-align:center;
    margin:0 0 12px;
    line-height:1.35;
  }

  /* --- DROP / CLICK --- */
  .drop{margin:0 auto 12px;width:min(720px,92%);background:rgba(43,47,66,.7);backdrop-filter:blur(8px);
        border:1px solid #6f7391;border-radius:20px;padding:12px 14px;text-align:center;cursor:pointer;transition:.15s}
  .drop:hover{filter:brightness(1.04)}
  .click-hint{color:var(--muted);font-size:.9rem;margin-top:2px}
  .hidden{display:none}

  /* --- HINTS: ALWAYS 2 COLUMNS --- */
  .hints{
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1fr); /* side-by-side, never stack */
    gap:8px 16px;
    align-items:center;
    justify-items:start;
    margin:6px 0 8px;
  }
  .hint{display:flex;gap:6px;color:var(--muted);font-size:.95rem;line-height:1; white-space:nowrap;}
  .hint .val{color:#cfd1da; overflow:hidden; text-overflow:ellipsis; max-width:100%;}

  /* --- STATS --- */
  .stats{display:flex;gap:14px;justify-content:center;align-items:stretch;margin:6px 0 8px;flex-wrap:wrap}
  .chip{background:var(--chip);padding:10px 14px;border-radius:12px;min-width:260px;
        display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line)}
  .chip .k{opacity:.9}
  .chip .v{font-weight:700}

  /* --- PANELS --- */
  .panel{background:rgba(23,26,37,.75);backdrop-filter:blur(6px);border:1px solid var(--line);
         border-radius:14px;padding:12px;flex:1 1 420px;min-height:320px}
  .panel h3{margin:0 0 6px}
  .list{height:260px;overflow:auto;background:#0f111a;border-radius:10px;padding:10px}

  /* --- BUTTONS --- */
  .btns{display:flex;gap:10px;justify-content:center;margin:12px 0 8px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:12px 18px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#3b3f56}

  /* --- FOOTER --- */
  .footer{color:var(--muted);text-align:center;margin:8px 0 24px}

  /* ---------- MOBILE ---------- */
  @media (max-width:600px){
    :root{ --logo-gap:-14px; } /* tighter gap on phones */
    .wrap{ padding: calc(10px + env(safe-area-inset-top)) 14px calc(16px + env(safe-area-inset-bottom)); }
    .logo{ max-width: clamp(180px, 58vw, 260px); margin-top:4px; }
    .subtitle{ font-size:.95rem; margin:2px 0 10px; }

    .hints{ gap:6px 10px; }  /* stays 2 columns */
    .hint{ font-size:.92rem }

    .stats{ flex-direction:column; gap:10px; }
    .chip{ width:100%; min-width:0; padding:12px 14px; }
    .chip .k{ font-size:.95rem } .chip .v{ font-size:1rem }

    .panel{ padding:10px; border-radius:12px; min-height:260px }
    .panel h3{ font-size:1.05rem }
    .list{ height:240px }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- Logo + subtitle -->
  <img class="logo" src="unfollowguard_logo.png" alt="UnfollowGuard" />
  <p class="subtitle">Analyze Instagram exports. Compare followers &amp; following, whitelist brands, and export results.</p>

  <!-- Drop + click -->
  <div id="drop" class="drop">
    <div><strong>Drag &amp; drop followers_*.json + following.json here</strong></div>
    <div class="click-hint">or <u><strong>click here</strong></u> to select your files</div>
    <input id="picker" type="file" accept=".json" multiple class="hidden" />
  </div>

  <!-- Hints -->
  <div class="hints">
    <div class="hint">Followers files: <span class="val" id="followersHint">none</span></div>
    <div class="hint">Following files: <span class="val" id="followingHint">none</span></div>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="chip"><span class="k">Followers</span><span class="v" id="followersCount">0</span></div>
    <div class="chip"><span class="k">Not Following You Back</span><span class="v" id="nfCount">0</span></div>
  </div>

  <!-- Results -->
  <div class="row">
    <div class="panel">
      <h3>Not Following You Back</h3>
      <div id="nfList" class="list"></div>
    </div>
    <div class="panel">
      <h3>You Don’t Follow Back</h3>
      <div id="ydfbList" class="list"></div>
    </div>
  </div>

  <!-- Actions -->
  <div class="btns">
    <button id="compareBtn" class="btn">Compare Now</button>
    <button id="exportBtn" class="btn secondary">Export Results</button>
    <button id="wlBtn" class="btn secondary">Manage Whitelist</button>
  </div>

  <p id="status" class="footer">Ready.</p>
</div>

<!-- Whitelist modal -->
<div id="wlModal" class="hidden wrap" style="max-width:720px">
  <h2>Whitelist (one username per line)</h2>
  <textarea id="wlText" class="whitelist"></textarea>
  <div class="btns">
    <button id="wlSave" class="btn">Save</button>
    <button id="wlClose" class="btn secondary">Close</button>
  </div>
</div>

<script>
const followersHint = document.getElementById('followersHint');
const followingHint = document.getElementById('followingHint');
const followersCount = document.getElementById('followersCount');
const nfCount = document.getElementById('nfCount');
const nfList = document.getElementById('nfList');
const ydfbList = document.getElementById('ydfbList');
const statusEl = document.getElementById('status');
const drop = document.getElementById('drop');
const picker = document.getElementById('picker');

let followers = new Set(), following = new Set();
let wl = new Set((localStorage.getItem('UG_whitelist')||'').split('\n').map(s=>s.trim().toLowerCase()).filter(Boolean));

function norm(s){ return s.trim().toLowerCase().replace(/^@/,''); }
function usernamesFrom(json){
  function fromArr(arr){ const out=new Set(); for(const e of arr||[]) {
    const sld = e?.string_list_data?.[0];
    if(sld?.value) out.add(norm(sld.value));
    else if(sld?.href){ try{ const u = new URL(sld.href); const first = u.pathname.replace(/^\/+/,'').split('/')[0]; if(first) out.add(norm(first)); } catch{} }
  } return out; }
  if(Array.isArray(json)) return fromArr(json);
  for(const k of ["relationships_followers","relationships_following","followers","following"]) if(json?.[k]) return fromArr(json[k]);
  return new Set();
}

async function loadFiles(fileList){
  const fUsed=[], gUsed=[];
  const files = Array.from(fileList);
  followers.clear(); following.clear();

  for(const file of files){
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      const names = usernamesFrom(data);
      if(file.name.toLowerCase().includes('following')) { names.forEach(n=>following.add(n)); gUsed.push(file.name); }
      else { names.forEach(n=>followers.add(n)); fUsed.push(file.name); }
    }catch(e){}
  }
  followersHint.textContent = fUsed.length? fUsed.slice(0,2).join(', ') + (fUsed.length>2?' ...':'') : 'none';
  followingHint.textContent = gUsed.length? gUsed.slice(0,2).join(', ') + (gUsed.length>2?' ...':'') : 'none';
  followersCount.textContent = followers.size;
  nfCount.textContent = "0";
  nfList.innerHTML = ""; ydfbList.innerHTML = "";
  statusEl.textContent = `Loaded ${followers.size} followers and ${following.size} following. Click Compare.`;
}

drop.addEventListener('click', ()=> picker.click());
picker.addEventListener('change', e => loadFiles(e.target.files));
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.filter='brightness(1.06)' });
drop.addEventListener('dragleave', ()=> drop.style.filter='' );
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.style.filter='';
  loadFiles(e.dataTransfer.files);
});

document.getElementById('compareBtn').addEventListener('click', ()=>{
  const nf = [...following].filter(u=>!followers.has(u) && !wl.has(u)).sort();
  const ydfb = [...followers].filter(u=>!following.has(u) && !wl.has(u)).sort();
  nfCount.textContent = nf.length;
  nfList.innerHTML = nf.map(u=>`<div>@${u}</div>`).join('');
  ydfbList.innerHTML = ydfb.map(u=>`<div>@${u}</div>`).join('');
  statusEl.textContent = `Compare complete. ${nf.length} not following you back, ${ydfb.length} you don’t follow back.`;
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  function download(name, rows){ const blob = new Blob([rows.join('\n')], {type:'text/plain'}); const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:name}); a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }
  const nf = Array.from(nfList.querySelectorAll('div')).map(d=>d.textContent.replace(/^@/,''));
  const ydfb = Array.from(ydfbList.querySelectorAll('div')).map(d=>d.textContent.replace(/^@/,''));
  download('not_following_you_back.txt', nf);
  download('you_dont_follow_back.txt', ydfb);
});

// Whitelist UI
const wlModal = document.getElementById('wlModal');
const wlText  = document.getElementById('wlText');
document.getElementById('wlBtn').addEventListener('click', ()=>{
  wlText.value = Array.from(wl).sort().join('\n');
  wlModal.classList.remove('hidden');
});
document.getElementById('wlClose').addEventListener('click', ()=> wlModal.classList.add('hidden'));
document.getElementById('wlSave').addEventListener('click', ()=>{
  wl = new Set(wlText.value.split('\n').map(s=>norm(s)).filter(Boolean));
  localStorage.setItem('UG_whitelist', Array.from(wl).join('\n'));
  wlModal.classList.add('hidden');
  statusEl.textContent = `Whitelist saved. ${wl.size} entries.`;
});
</script>
</body>
</html>
